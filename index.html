<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Reha Programm" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,..." />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>Reha Programm</title>
</head>
<body class="center-auth">

  <!-- ğŸ”˜ MenÃ¼-Button oben links -->
  <button id="menuToggle" class="menu-toggle" style="display:none;">â˜°</button>

  <!-- ğŸŒ SeitenmenÃ¼ -->
  <div id="sidebar">
    <div class="sidebar-header">
      <h2>MenÃ¼</h2>
      <button id="closeSidebar">Ã—</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#trainingsplan" id="menu-trainingsplan">ğŸ‹ï¸ Trainingsplan</a></li>
      <li><a href="#fortschritt" id="menu-fortschritt">ğŸ“Š Fortschritt</a></li>
      <li><a href="#tagesprogramm" id="menu-tagesprogramm">ğŸ—“ï¸ Tagesprogramm</a></li>
      <li><a href="#kalender" id="menu-kalender">ğŸ“… Kalender</a></li>
      <li><a href="#feedback" id="menu-feedback">ğŸ’¬ Feedback</a></li>
      <li><a href="#profil" id="menu-profil">ğŸ‘¤ Profil</a></li>
      <li><a href="#hilfe" id="menu-hilfe">â“ Hilfe</a></li>
    </ul>
  </div>

  <!-- ğŸ”’ Login / Registrierung -->
  <div class="card" id="auth-forms">
    <h2>Anmeldung</h2>
    <form id="login-form">
      <input id="li-email" type="email" placeholder="E-Mail" required />
      <input id="li-password" type="password" placeholder="Passwort" required />
      <button type="submit">Anmelden</button>
    </form>

    <details style="margin-top:12px;">
      <summary>Konto erstellen</summary>
      <form id="signup-form" style="margin-top:8px;">
        <input id="su-email" type="email" placeholder="E-Mail" required />
        <input id="su-password" type="password" placeholder="Passwort" required />
        <button type="submit">Konto erstellen</button>
      </form>
    </details>
  </div>

  <!-- ğŸ” GeschÃ¼tzte App -->
  <div id="app" class="container" style="display:none;">
    <div id="user-area" style="position:absolute; top:10px; right:15px; font-size:0.9rem;">
      <span id="user-info">Nicht angemeldet</span>
      <button id="sign-out" style="display:none;">Abmelden</button>
    </div>

    <div id="app-section">
      <main id="content" class="main-content"></main>
    </div>

    <div class="sync-status" id="syncStatus">Synchronisiere...</div>
    <div class="edit-section" id="editSection">
      <div class="edit-area active" id="editArea">
        <textarea class="edit-textarea" id="scheduleEditor" placeholder="Programm hier bearbeiten..."></textarea>
        <button class="save-btn" id="saveBtn">Speichern</button>
        <div class="qr-section">
          <div class="qr-title">App teilen via QR-Code</div>
          <div class="qr-code" id="qrCode"></div>
          <div class="qr-url" id="qrUrl"></div>
        </div>
      </div>
    </div>

    <!-- ğŸ“ Notizen Modal -->
    <div class="note-modal" id="noteModal">
      <div class="note-modal-content">
        <div class="note-modal-title" id="noteModalTitle">Notiz hinzufÃ¼gen</div>
        <textarea class="note-textarea" id="noteTextarea" placeholder="Hier kÃ¶nnen Sie eine Notiz zu diesem Termin hinzufÃ¼gen..."></textarea>
        <div class="note-modal-buttons">
          <button class="note-save-btn" id="noteSaveBtn">Speichern</button>
          <button class="note-cancel-btn" id="noteCancelBtn">Abbrechen</button>
        </div>
        <button class="note-delete-btn" id="noteDeleteBtn" style="display: none;">Notiz lÃ¶schen</button>
      </div>
    </div>
  </div>

  <script src="schedule-data.js"></script>

  <!-- ... dein bisheriges HTML bleibt unverÃ¤ndert ... -->

<script type="module">
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDJkR9vgTV4tzkVYGUQzA8o-bEU2Lq_now",
    authDomain: "reha-app-3d609.firebaseapp.com",
    projectId: "reha-app-3d609",
    storageBucket: "reha-app-3d609.firebasestorage.app",
    messagingSenderId: "805175943839",
    appId: "1:805175943839:web:60e9ffefba4eb4ccb7f8aa"
  };
  const appFB = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getFirestore(appFB);

  const authForms = document.getElementById("auth-forms");
  const appDiv = document.getElementById("app");
  const userInfo = document.getElementById("user-info");
  const signOutBtn = document.getElementById("sign-out");
  const sidebar = document.getElementById("sidebar");
  const menuToggle = document.getElementById("menuToggle");
  const closeSidebar = document.getElementById("closeSidebar");

  const showAuth = () => {
    document.body.classList.add("center-auth");
    authForms.style.display = "block";
    appDiv.style.display = "none";
  };
  const showApp = () => {
    document.body.classList.remove("center-auth");
    authForms.style.display = "none";
    appDiv.style.display = "block";
  };

  function loadAppJSOnce() {
    if (document.getElementById("app-js-loaded")) return;
    const s = document.createElement("script");
    s.src = "app.js";
    s.id = "app-js-loaded";
    s.type = "module";
    document.body.appendChild(s);
  }

  // Login / Registrierung / Logout unverÃ¤ndert ...
  // ...

  // --- Hash Router bleibt unverÃ¤ndert ---

  // ğŸ”’ Auth-Zustand
  let didInitialLoad = false;
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      showApp();
      setMenuToggleVisible(true);
      loadAppJSOnce?.();

      // ğŸ”§ NEU: Aktuellen Nutzer global speichern
      const name = user.displayName || user.email || ("UID:" + user.uid);
      window.currentUserName = name;

      userInfo.textContent = `Angemeldet: ${name}`;
      signOutBtn.style.display = "inline-block";

      if (!didInitialLoad) {
        if (!location.hash) location.hash = "#tagesprogramm";
        routeToHash();
        didInitialLoad = true;
      }
    } else {
      showAuth();
      setMenuToggleVisible(false);
      didInitialLoad = false;

      // ğŸ”§ NEU: Beim Abmelden User-Name lÃ¶schen
      window.currentUserName = null;

      userInfo.textContent = "Nicht angemeldet";
      signOutBtn.style.display = "none";
    }
  });
</script>
</body>
</html>
