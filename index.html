<script type="module">
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // --- Firebase Config & Init (dein bestehender Code, unverändert) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDJkR9vgTV4tzkVYGUQzA8o-bEU2Lq_now",
    authDomain: "reha-app-3d609.firebaseapp.com",
    projectId: "reha-app-3d609",
    storageBucket: "reha-app-3d609.firebasestorage.app",
    messagingSenderId: "805175943839",
    appId: "1:805175943839:web:60e9ffefba4eb4ccb7f8aa"
  };
  const appFB = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getFirestore(appFB);

  const authForms = document.getElementById("auth-forms");
  const appDiv    = document.getElementById("app");
  const userInfo  = document.getElementById("user-info");
  const signOutBtn= document.getElementById("sign-out");
  const sidebar   = document.getElementById("sidebar");
  const menuToggle= document.getElementById("menuToggle");
  const closeSidebar = document.getElementById("closeSidebar");

  const showAuth = () => { document.body.classList.add("center-auth"); authForms.style.display="block"; appDiv.style.display="none"; };
  const showApp  = () => { document.body.classList.remove("center-auth"); authForms.style.display="none"; appDiv.style.display="block"; };

  function loadAppJSOnce() {
    if (document.getElementById("app-js-loaded")) return;
    const s = document.createElement("script");
    s.src = "app.js";
    s.id  = "app-js-loaded";
    s.type = "module";
    document.body.appendChild(s);
  }

  // Login / Signup / Logout (dein Code unverändert)
  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("li-email").value.trim();
    const pw = document.getElementById("li-password").value;
    try { await signInWithEmailAndPassword(auth, email, pw); }
    catch (err) { alert("Login fehlgeschlagen: " + err.message); }
  });
  document.getElementById("signup-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("su-email").value.trim();
    const pw = document.getElementById("su-password").value;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      await setDoc(doc(db, "profiles", cred.user.uid), { email, createdAt: Date.now() });
      alert("Registriert! Du kannst dich jetzt anmelden.");
    } catch (err) {
      alert("Registrierung fehlgeschlagen: " + err.message);
    }
  });
  signOutBtn.addEventListener("click", async () => { try { await signOut(auth); } catch { alert("Abmelden fehlgeschlagen."); } });

  // Sidebar Toggle
  const setMenuToggleVisible = (visible) => { if (menuToggle) menuToggle.style.display = visible ? "block" : "none"; };
  menuToggle?.addEventListener("click", () => sidebar.classList.toggle("active"));
  closeSidebar?.addEventListener("click", () => sidebar.classList.remove("active"));

  // ---------- Views dynamisch laden (inkl. CSS & JS) ----------
  async function loadView(page) {
    const mount = document.getElementById("content");
    const viewPath = `views/${page}.html`;
    const cssPath  = `views/${page}.css`;
    const jsPath   = `views/${page}.js`;

    try {
      // 1) HTML laden
      const res = await fetch(viewPath);
      if (!res.ok) throw new Error(`HTTP ${res.status} – ${viewPath}`);
      const html = await res.text();

      // 2) Nur Body-Inhalt extrahieren
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const newContent = doc.body.innerHTML;

      // 3) Altes View-CSS entfernen & neues anhängen
      document.querySelectorAll('link[data-view]').forEach(l => l.remove());
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = cssPath;
      link.dataset.view = page;
      document.head.appendChild(link);

      // 4) Inhalt ersetzen
      mount.innerHTML = newContent;

      // 5) View-JS neu laden
      document.getElementById("dynamic-view-script")?.remove();
      const script = document.createElement("script");
      script.src = jsPath;
      script.id = "dynamic-view-script";
      script.defer = true;
      document.body.appendChild(script);

    } catch (e) {
      document.getElementById("content").innerHTML =
        `<div style="padding:1rem;">❌ Konnte "${page}" nicht laden.<br>${e}</div>`;
      console.error(e);
    }
  }

  // ---------- Mini-Router über Hash ----------
  function routeToHash() {
    // Hash -> page (Default: tagesprogramm)
    let page = (location.hash || "#tagesprogramm").slice(1).trim();
    if (!page) page = "tagesprogramm";

    loadView(page);                      // View laden
    sidebar?.classList.remove("active"); // Sidebar schließen (mobil)

    // aktives Menü markieren (optional)
    document.querySelectorAll(".sidebar-menu a").forEach(a => {
      a.classList.toggle("active", a.getAttribute("href") === `#${page}`);
    });
  }
  window.addEventListener("hashchange", routeToHash);

  // ---------- Auth-State ----------
  let didInitialLoad = false;
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      showApp();
      setMenuToggleVisible(true);
      loadAppJSOnce?.();

      if (!didInitialLoad) {
        if (!location.hash) location.hash = "#tagesprogramm"; // Startseite setzen
        routeToHash();  // lädt die View basierend auf dem Hash (z. B. #kalender)
        didInitialLoad = true;
      }
    } else {
      showAuth();
      setMenuToggleVisible(false);
      didInitialLoad = false;
    }
  });
</script>
