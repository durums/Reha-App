<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Reha Programm" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,..." />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>Reha Programm</title>
</head>
<body class="center-auth">

  <!-- üîò Men√º-Button oben links (wird nach Login eingeblendet) -->
  <button id="menuToggle" class="menu-toggle" style="display:none;">‚ò∞</button>

  <!-- üåê Seitenmen√º -->
  <div id="sidebar">
    <div class="sidebar-header">
      <h2>Men√º</h2>
      <button id="closeSidebar">√ó</button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#tagesprogramm" id="menu-tagesprogramm">üóìÔ∏è Tagesprogramm</a></li>
      <li><a href="#trainingsplan" id="menu-trainingsplan">üèãÔ∏è Trainingsplan</a></li>
      <li><a href="#fortschritt" id="menu-fortschritt">üìä Fortschritt</a></li>
      <li><a href="#kalender" id="menu-kalender">üìÖ Kalender</a></li>
      <li><a href="#feedback" id="menu-feedback">üí¨ Feedback</a></li>
      <li><a href="#profil" id="menu-profil">üë§ Profil</a></li>
      <li><a href="#hilfe" id="menu-hilfe">‚ùì Hilfe</a></li>
    </ul>
  </div>

  <!-- üîí Login / Registrierung -->
  <div class="card" id="auth-forms">
    <h2>Anmeldung</h2>
    <form id="login-form">
      <input id="li-email" type="email" placeholder="E-Mail" required />
      <input id="li-password" type="password" placeholder="Passwort" required />
      <button type="submit">Anmelden</button>
    </form>

    <details style="margin-top:12px;">
      <summary>Konto erstellen</summary>
      <form id="signup-form" style="margin-top:8px;">
        <input id="su-email" type="email" placeholder="E-Mail" required />
        <input id="su-password" type="password" placeholder="Passwort" required />
        <button type="submit">Konto erstellen</button>
      </form>
    </details>
  </div>

  <!-- üîê Gesch√ºtzte App -->
  <div id="app" class="container" style="display:none;">
    <div id="user-area" style="position:absolute; top:10px; right:15px; font-size:0.9rem;">
      <span id="user-info">Nicht angemeldet</span>
      <button id="sign-out" style="display:none;">Abmelden</button>
    </div>

    <div id="app-section">
      <div class="app-card">
        <h1>Reha Tagesprogramm</h1>
        <div class="date-nav">
          <button id="prevDay" class="nav-btn">‚Äπ</button>
          <span id="currentDate" class="current-date"></span>
          <button id="nextDay" class="nav-btn">‚Ä∫</button>
        </div>
      </div>

      <!-- üëâ EINZIGE View-Fl√§che (hier werden views/*.html geladen) -->
      <div id="content" class="main-content"></div>

      <!-- Editor / QR (falls du sie brauchst ‚Äì sonst entfernen) -->
      <div class="edit-section" id="editSection">
        <div class="edit-area active" id="editArea">
          <textarea class="edit-textarea" id="scheduleEditor" placeholder="Programm hier bearbeiten..."></textarea>
          <button class="save-btn" id="saveBtn">Speichern</button>
          <div class="qr-section">
            <div class="qr-title">App teilen via QR-Code</div>
            <div class="qr-code" id="qrCode"></div>
            <div class="qr-url" id="qrUrl"></div>
          </div>
        </div>
      </div>

      <!-- üìù Notizen Modal -->
      <div class="note-modal" id="noteModal">
        <div class="note-modal-content">
          <div class="note-modal-title" id="noteModalTitle">Notiz hinzuf√ºgen</div>
          <textarea class="note-textarea" id="noteTextarea" placeholder="Hier k√∂nnen Sie eine Notiz zu diesem Termin hinzuf√ºgen..."></textarea>
          <div class="note-modal-buttons">
            <button class="note-save-btn" id="noteSaveBtn">Speichern</button>
            <button class="note-cancel-btn" id="noteCancelBtn">Abbrechen</button>
          </div>
          <button class="note-delete-btn" id="noteDeleteBtn" style="display: none;">Notiz l√∂schen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Falls von dir genutzt -->
  <script src="schedule-data.js"></script>

  <!-- App-Script -->
  <script type="module">
    // --- Firebase ---
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJkR9vgTV4tzkVYGUQzA8o-bEU2Lq_now",
      authDomain: "reha-app-3d609.firebaseapp.com",
      projectId: "reha-app-3d609",
      storageBucket: "reha-app-3d609.firebasestorage.app",
      messagingSenderId: "805175943839",
      appId: "1:805175943839:web:60e9ffefba4eb4ccb7f8aa"
    };
    const appFB = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // --- DOM-Refs ---
    const authForms = document.getElementById("auth-forms");
    const appDiv    = document.getElementById("app");
    const userInfo  = document.getElementById("user-info");
    const signOutBtn= document.getElementById("sign-out");
    const sidebar   = document.getElementById("sidebar");
    const menuToggle= document.getElementById("menuToggle");
    const closeSidebar = document.getElementById("closeSidebar");

    // --- Sichtbarkeit Login/App ---
    const showAuth = () => {
      document.body.classList.add("center-auth");
      authForms.style.display = "block";
      appDiv.style.display = "none";
    };
    const showApp = () => {
      document.body.classList.remove("center-auth");
      authForms.style.display = "none";
      appDiv.style.display = "block";
    };

    // --- Men√º-Button & Sidebar ---
    const setMenuToggleVisible = (visible) => {
      if (menuToggle) menuToggle.style.display = visible ? "block" : "none";
    };
    menuToggle?.addEventListener("click", () => {
      sidebar.classList.toggle("active");
    });
    closeSidebar?.addEventListener("click", () => {
      sidebar.classList.remove("active");
    });

    // --- Login ---
    document.getElementById("login-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("li-email").value.trim();
      const pw    = document.getElementById("li-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        alert("Login fehlgeschlagen: " + err.message);
        console.error(err);
      }
    });

    // --- Signup ---
    document.getElementById("signup-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("su-email").value.trim();
      const pw    = document.getElementById("su-password").value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await setDoc(doc(db, "profiles", cred.user.uid), { email, createdAt: Date.now() });
        alert("Registriert! Du kannst dich jetzt anmelden.");
      } catch (err) {
        alert("Registrierung fehlgeschlagen: " + err.message);
        console.error(err);
      }
    });

    // --- Logout ---
    signOutBtn?.addEventListener("click", async () => {
      try { await signOut(auth); }
      catch (e) { console.error(e); alert("Abmelden fehlgeschlagen."); }
    });

    // --- Views laden (Hash-Router) ---
    async function loadView(page) {
      try {
        const res = await fetch(`views/${page}.html`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();
        document.getElementById("content").innerHTML = html;
        // Sidebar nach Navigation schlie√üen
        sidebar?.classList.remove("active");
      } catch (err) {
        document.getElementById("content").innerHTML =
          `<div style="padding:1rem;color:#b00020;background:#ffecec;border-radius:8px;">
             Konnte "<b>${page}</b>" nicht laden.<br>Fehler: ${err.message}
           </div>`;
      }
    }
    function getPageFromHash() {
      return (location.hash || "#tagesprogramm").replace("#", "");
    }
    function routeToHash() {
      loadView(getPageFromHash());
    }
    window.addEventListener("hashchange", routeToHash);

    // --- App.js einmalig laden (falls von dir genutzt) ---
    function loadAppJSOnce() {
      if (document.getElementById("app-js-loaded")) return;
      const s = document.createElement("script");
      s.src = "app.js";
      s.id  = "app-js-loaded";
      s.type = "module";
      document.body.appendChild(s);
    }

    // --- Auth-Zustand ---
    let didInitialLoad = false;
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        showApp();
        setMenuToggleVisible(true);
        loadAppJSOnce();

        const name = user.displayName || user.email || ("UID:" + user.uid);
        window.currentUserName = name;
        if (userInfo) userInfo.textContent = `Angemeldet: ${name}`;
        if (signOutBtn) signOutBtn.style.display = "inline-block";

        if (!didInitialLoad) {
          if (!location.hash) location.hash = "#tagesprogramm";
          routeToHash();
          didInitialLoad = true;
        }
      } else {
        showAuth();
        setMenuToggleVisible(false);
        didInitialLoad = false;
        window.currentUserName = null;
        if (userInfo) userInfo.textContent = "Nicht angemeldet";
        if (signOutBtn) signOutBtn.style.display = "none";
      }
    });
  </script>
</body>
</html>
