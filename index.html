<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Reha Programm" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,..." />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>Reha Tagesprogramm</title>
</head>
<body>
  
  <!-- Anzeige angemeldeter Benutzer -->
  <div id="user-area" style="display:flex;align-items:center;gap:0.5rem;">
    <span id="user-info">Nicht angemeldet</span>
    <button id="sign-out" style="display:none;">Abmelden</button>
  </div>

  <!-- üîí Login / Registrierung -->
  <div class="card" id="auth-forms">
    <h2>Anmeldung</h2>
    <form id="login-form">
      <input id="li-email" type="email" placeholder="E-Mail" required />
      <input id="li-password" type="password" placeholder="Passwort" required />
      <button type="submit">Anmelden</button>
    </form>

    <details style="margin-top:12px;">
      <summary>Konto erstellen</summary>
      <form id="signup-form" style="margin-top:8px;">
        <input id="su-email" type="email" placeholder="E-Mail" required />
        <input id="su-password" type="password" placeholder="Passwort" required />
        <button type="submit">Konto erstellen</button>
      </form>
    </details>
  </div>

  <!-- üîê Gesch√ºtzte App -->
  <div id="app" class="container" style="display:none;">
    <header class="header">
      <h1 id="titleButton">Reha Tagesprogramm</h1>
      <div class="date-nav">
        <button class="nav-btn" id="prevDay">‚Äπ</button>
        <div class="current-date" id="currentDate"></div>
        <button class="nav-btn" id="nextDay">‚Ä∫</button>
        <div id="user-area" style="display:flex;align-items:center;gap:0.5rem;">
          <span id="user-info">Nicht angemeldet</span>
          <button id="sign-out" style="display:none;">Abmelden</button>
        </div>
      </div>
      <!-- optional -->
      <!-- <button id="logoutBtn" class="nav-btn">Logout</button> -->
    </header>

    <main class="main-content">
      <div class="sync-status" id="syncStatus">Synchronisiere...</div>

      <div id="scheduleContainer"></div>

      <div class="edit-section" id="editSection">
        <div class="edit-area active" id="editArea">
          <textarea class="edit-textarea" id="scheduleEditor" placeholder="Programm hier bearbeiten..."></textarea>
          <button class="save-btn" id="saveBtn">Speichern</button>

          <div class="qr-section">
            <div class="qr-title">App teilen via QR-Code</div>
            <div class="qr-code" id="qrCode"></div>
            <div class="qr-url" id="qrUrl"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Notizen Modal (jetzt innerhalb von #app) -->
    <div class="note-modal" id="noteModal">
      <div class="note-modal-content">
        <div class="note-modal-title" id="noteModalTitle">Notiz hinzuf√ºgen</div>
        <textarea class="note-textarea" id="noteTextarea" placeholder="Hier k√∂nnen Sie eine Notiz zu diesem Termin hinzuf√ºgen..."></textarea>
        <div class="note-modal-buttons">
          <button class="note-save-btn" id="noteSaveBtn">Speichern</button>
          <button class="note-cancel-btn" id="noteCancelBtn">Abbrechen</button>
        </div>
        <button class="note-delete-btn" id="noteDeleteBtn" style="display: none;">Notiz l√∂schen</button>
      </div>
    </div>
  </div>

  <script src="schedule-data.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJkR9vgTV4tzkVYGUQzA8o-bEU2Lq_now",
      authDomain: "reha-app-3d609.firebaseapp.com",
      projectId: "reha-app-3d609",
      storageBucket: "reha-app-3d609.firebasestorage.app",
      messagingSenderId: "805175943839",
      appId: "1:805175943839:web:60e9ffefba4eb4ccb7f8aa"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    const authForms = document.getElementById("auth-forms");
    const appDiv = document.getElementById("app");

    const showAuth = () => { authForms.style.display = "block"; appDiv.style.display = "none"; };
    const showApp  = () => { authForms.style.display = "none";  appDiv.style.display = "block"; };

    // Login
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("li-email").value.trim();
      const pw = document.getElementById("li-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        alert(err.message);
      }
    });

    // Signup
    document.getElementById("signup-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("su-email").value.trim();
      const pw = document.getElementById("su-password").value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await setDoc(doc(db, "profiles", cred.user.uid), { email, createdAt: Date.now() });
        alert("Registriert! Du kannst dich jetzt anmelden.");
      } catch (err) {
        alert(err.message);
      }
    });
  <script type="module">
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js";
  
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
    // App erst nach Login laden
  function loadAppJSOnce() {
    // verhindert mehrfaches Laden
    if (document.getElementById("app-js-loaded")) return;
    const s = document.createElement("script");
    s.src = "app.js";
    s.id  = "app-js-loaded";
    s.type = "module"; // wichtig, falls app.js auch Module nutzt
    document.body.appendChild(s);
  }
  
  function showApp() {
    document.getElementById("app-section").style.display = "block";
    document.getElementById("auth-section").style.display = "none";
  }
  
  function showAuth() {
    document.getElementById("app-section").style.display = "none";
    document.getElementById("auth-section").style.display = "block";
  }
  
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Eingeloggt als:", user.email || user.uid);
      showApp();
      loadAppJSOnce();
  
      // Custom Claims / Rollen optional abrufen:
      user.getIdTokenResult().then(t => {
        console.log("Custom claims:", t.claims);
      });
    } else {
      console.log("Kein Nutzer angemeldet.");
      showAuth();
    }
  });
  
  // Optional: Logout-Button
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    signOut(auth);
  });
  </script>
  
</body>
</html>
