<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Reha Programm" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,..." />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>Reha Programm</title>
  <style>
    /* kleine ErgÃ¤nzung fÃ¼r "Willkommen" */
    .sidebar-account .welcome-text { font-size:.9rem; color:#888; margin:2px 0 4px 4px; }
  </style>
</head>
<body class="center-auth">

  <!-- ğŸ”˜ MenÃ¼-Button oben links -->
  <button id="menu-toggle" class="menu-toggle" aria-label="MenÃ¼ Ã¶ffnen" hidden>
    â˜°
  </button>

  <div class="app-shell">
    <aside id="sidebar" class="sidebar-container">
      <header class="sidebar-header">
        <div class="sidebar-logo">ğŸ¥</div>
        <div>
          <div class="sidebar-title">Reha Programm</div>
          <div class="sidebar-subtitle">Dein persÃ¶nlicher Rehaplan</div>
        </div>
      </header>

      <div class="sidebar-account">
        <div id="account-info" class="account-box">
          <div class="welcome-text">Willkommen</div>
          <div id="account-email" class="account-email">Gast</div>
        </div>
      </div>

      <nav class="sidebar">
        <a href="#trainingsplan" data-match="trainingsplan">ğŸ‹ï¸ Trainingsplan</a>
        <a href="#fortschritt"   data-match="fortschritt">ğŸ“Š Fortschritt</a>
        <a href="#tagesprogramm" data-match="tagesprogramm">ğŸ—“ï¸ Tagesprogramm</a>
        <a href="#kalender"      data-match="kalender">ğŸ“… Kalender</a>
        <a href="#kalender2"     data-match="kalender2">ğŸ†• Kalender 2.0</a>
        <a href="#termine"       data-match="termine">ğŸ—‚ï¸ Termine</a>
        <a href="#kontaktieren"  data-match="feedback">ğŸ“ Kontaktieren</a>
        <a href="#rezepte"       data-match="rezepte">ğŸ§¾ Rezepte</a>
        <a href="#feedback"      data-match="feedback">â­ Feedback</a>
        <a href="#profil"        data-match="profil">ğŸ‘¤ Profil</a>
        <a href="#hilfe"         data-match="hilfe">â“ Hilfe</a>
      </nav>
    
      <div class="sidebar-footer">
        <button id="sign-out" class="logout-btn">ğŸšª Abmelden</button>
      </div>
    </aside>

    <main id="content" class="content">
      <section class="auth-panel">
        <h1 id="auth-title">Anmelden</h1>

        <!-- LOGIN-FORMULAR -->
        <form id="login-form" class="auth-form">
          <input id="li-email"    type="email"    placeholder="E-Mail" required />
          <input id="li-password" type="password" placeholder="Passwort" required />
  
          <div class="login-actions" style="display:flex;justify-content:space-between;gap:.5rem;align-items:center;margin:.5rem 0 0;">
            <button type="submit">Anmelden</button>
            <button type="button" id="forgotBtn" class="linklike-btn" style="background:none;border:none;color:#2563EB;cursor:pointer;padding:.25rem .25rem;">
              Passwort vergessen?
            </button>
          </div>
        </form>
  
        <!-- Link zum Signup -->
        <div style="margin-top:12px;">
          <a href="#signup" id="signupLink" style="color:#2563EB;text-decoration:underline;">Konto erstellen</a>
        </div>
  
        <!-- SIGNUP-FORMULAR -->
        <form id="signup-form" class="auth-form" style="display:none;">
          <input id="su-displayName" type="text"     placeholder="Name (optional)" />
          <input id="su-email"       type="email"    placeholder="E-Mail" required />
          <input id="su-password"    type="password" placeholder="Passwort (min. 6 Zeichen)" required />
          <button type="submit">Registrieren</button>
        </form>
      </section>
    </main>
  </div>

  <!-- Firebase Config (fÃ¼r Host/Domain anpassen, wenn nÃ¶tig) -->
  <script>
    window.FIREBASE_CONFIG = {
      apiKey:            "DEIN_API_KEY_HIER",
      authDomain:        "DEIN_AUTH_DOMAIN.firebaseapp.com",
      projectId:         "DEIN_PROJECT_ID",
      storageBucket:     "DEIN_BUCKET_ID.appspot.com",
      messagingSenderId: "DEINE_SENDER_ID",
      appId:             "DEINE_APP_ID"
    };
  </script>

  <!-- ğŸ” Reha-Plan Daten -->
  <script src="schedule-data.js"></script>

  <script type="module">
    /* ======================
       1) IMPORTS (mÃ¼ssen ganz oben stehen)
       ====================== */
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      sendPasswordResetEmail, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  
    /* ======================
       2) FIREBASE INIT
       ====================== */
    const firebaseConfig = window.FIREBASE_CONFIG;
    let app;
    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
    } else {
      app = getApp();
    }
    const auth = getAuth(app);
    const db   = getFirestore(app);
  
    /* ======================
       3) HILFSFUNKTIONEN UI
       ====================== */
    const sidebar     = document.getElementById("sidebar");
    const menuToggle  = document.getElementById("menu-toggle");
  
    function setMenuToggleVisible(visible) {
      if (!menuToggle) return;
      if (visible) {
        menuToggle.hidden = false;
      } else {
        menuToggle.hidden = true;
      }
    }
  
    if (menuToggle && sidebar) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("active");
      });
    }
  
    /* ======================
       4) ACCOUNT-INFO im Sidebar
       ====================== */
    function updateSidebarAccount(user) {
      const emailEl = document.getElementById("account-email");
      if (!emailEl) return;
      if (!user) {
        emailEl.textContent = "Gast";
        return;
      }
      emailEl.textContent = user.email || "Angemeldet";
    }
  
    /* ======================
       5) Sidebar-Links: Klick schlieÃŸt Sidebar auf Mobile
       ====================== */
    const navEl = document.querySelector("#sidebar nav.sidebar");
    if (navEl) {
      navEl.addEventListener("click", (e) => {
        const link = e.target.closest("a");
        if (!link) return;
        sidebar.classList.remove("active");
        setMenuToggleVisible(true);
      });
    }
  
    const signOutBtn = document.getElementById("sign-out");
    if (signOutBtn) {
      signOutBtn.addEventListener("click", async () => {
        sidebar.classList.remove("active");
        setMenuToggleVisible(true);
        try { await signOut(auth); } catch { alert("Abmelden fehlgeschlagen."); }
      });
    }
  
    /* ======================
       5) VIEW LOADER & ROUTER
       ====================== */
    async function loadView(page) {
      const mount = document.getElementById("content");

      // âœ¨ Spezialbehandlung fÃ¼r Kalender / Kalender 2.0
      let basePage = page;

      // Standardwerte zurÃ¼cksetzen
      window.DEFAULT_KALENDER_TAB = null;
      window.KALENDER2_MODE = null;

      if (page === "kalender2") {
        // gleiche View-Dateien wie "kalender" laden
        basePage = "kalender";

        // Direkt Tab "Kalender 2.0 â€“ Rehaplan" aktiv
        window.DEFAULT_KALENDER_TAB = "reha";

        // Statt Kalender-Raster: Bulletlist aus Rehaplan
        window.KALENDER2_MODE = "list";
      } else if (page === "kalender") {
        // Normal: Tab Kalender 1.0
        basePage = "kalender";
        window.DEFAULT_KALENDER_TAB = "basic";
      }

      const viewPath = `views/${basePage}.html`;
      const cssPath  = `views/${basePage}.css`;
      const jsPath   = `views/${basePage}.js`;

      try {
        const res  = await fetch(viewPath);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();

        const parser    = new DOMParser();
        const doc       = parser.parseFromString(html, "text/html");
        const newContent = doc.body.innerHTML;

        document.querySelectorAll('link[data-view]').forEach(l => l.remove());
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = cssPath;
        link.dataset.view = basePage;
        document.head.appendChild(link);

        if (mount) mount.innerHTML = newContent;

        document.getElementById("dynamic-view-script")?.remove();
        const script = document.createElement("script");
        script.src = jsPath;
        script.id  = "dynamic-view-script";
        script.defer = true;
        document.body.appendChild(script);
      } catch (e) {
        if (mount) {
          mount.innerHTML =
            `<div style="padding:1rem;">âŒ Konnte "${page}" nicht laden.<br>${e}</div>`;
        }
      }
    }

    function routeToHash() {
      let page = (location.hash || "#tagesprogramm").slice(1).trim();
      if (!page) page = "tagesprogramm";

      // WICHTIG: Diese Hashes sind nur fÃ¼r die Auth-View â€“ keine View laden
      if (page === "signup" || page === "login") {
        updateAuthView();
        return;
      }
  
      loadView(page);
      sidebar.classList.remove("active");
      setMenuToggleVisible(true);
      document.querySelectorAll("#sidebar nav.sidebar a").forEach(a => {
        a.classList.toggle("active", a.getAttribute("href") === `#${page}`);
      });
      try { localStorage.setItem("rehapp:lastPage", page); } catch {}
    }
  
    window.addEventListener("hashchange", routeToHash);
  
    /* ======================
       6) AUTH: LOGIN / SIGNUP / RESET
       ====================== */
    const loginForm = document.getElementById("login-form");
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("li-email")?.value.trim();
        const pw    = document.getElementById("li-password")?.value;
        if (!email || !pw) return;
        try {
          await signInWithEmailAndPassword(auth, email, pw);
          location.hash = "#tagesprogramm";
          routeToHash();
        } catch (err) {
          alert(`Login fehlgeschlagen: ${err.code}`);
        }
        return false;
      });
    }
  
    const signupForm = document.getElementById("signup-form");
    if (signupForm) {
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("su-email")?.value.trim();
        const pw    = document.getElementById("su-password")?.value;
        const name  = document.getElementById("su-displayName")?.value.trim();
        if (!email || !pw) return;
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pw);
          if (name) {
            await updateProfile(cred.user, { displayName: name });
          }
          await setDoc(doc(db, "users", cred.user.uid), {
            email,
            displayName: name || null,
            createdAt: serverTimestamp()
          });
          alert("Konto erstellt. Du bist jetzt angemeldet.");
          location.hash = "#tagesprogramm";
          routeToHash();
        } catch (err) {
          console.error("Signup fehlgeschlagen:", err);
          const map = {
            "auth/operation-not-allowed": "E-Mail/Passwort ist im Projekt nicht aktiviert.",
            "auth/email-already-in-use": "Diese E-Mail wird bereits verwendet.",
            "auth/invalid-email": "Die E-Mail-Adresse ist ungÃ¼ltig.",
            "auth/weak-password": "Passwort ist zu schwach (mind. 6 Zeichen).",
            "auth/network-request-failed": "Netzwerkfehler (z. B. von file:// gestartet?).",
            "auth/unauthorized-domain": "Domain nicht bei Firebase autorisiert."
          };
          alert(map[err.code] || `Registrierung fehlgeschlagen: ${err.code || err.message}`);
        }
      });
    }
  
    const signupLink = document.getElementById("signupLink");
    const forgotBtn  = document.getElementById("forgotBtn");
    if (signupLink) {
      signupLink.addEventListener("click", (e) => {
        e.preventDefault();
        location.hash = "#signup";
        updateAuthView();
      });
    }
    if (forgotBtn) {
      forgotBtn.addEventListener("click", async () => {
        const email = document.getElementById("li-email")?.value.trim();
        if (!email) {
          alert("Bitte zuerst deine E-Mail im Feld eintragen.");
          return;
        }
        try {
          await sendPasswordResetEmail(auth, email);
          alert("Passwort-ZurÃ¼cksetzen-E-Mail wurde gesendet.");
        } catch (err) {
          alert(`Fehler beim Senden der Reset-Mail: ${err.code || err.message}`);
        }
      });
    }
  
    /* ======================
       7) AUTH STATE -> UI & ROUTING
       ====================== */
    function updateAuthView() {
      const loginForm  = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const titleEl    = document.getElementById("auth-title");

      const hash = (location.hash || "#login").slice(1);

      if (hash === "signup") {
        if (titleEl) titleEl.textContent = "Konto erstellen";
        if (loginForm)  loginForm.style.display = "none";
        if (signupForm) signupForm.style.display = "block";
      } else {
        if (titleEl) titleEl.textContent = "Anmelden";
        if (loginForm)  loginForm.style.display = "block";
        if (signupForm) signupForm.style.display = "none";
      }
    }

    onAuthStateChanged(auth, (user) => {
      const main = document.querySelector("main#content");
      if (!user) {
        document.body.classList.add("center-auth");
        if (main) {
          main.innerHTML = document.querySelector(".auth-panel")?.outerHTML || "";
        }
        updateAuthView();
        updateSidebarAccount(null);
        setMenuToggleVisible(false);
      } else {
        document.body.classList.remove("center-auth");
        updateSidebarAccount(user);
        setMenuToggleVisible(true);
        if (!location.hash || location.hash === "#login" || location.hash === "#signup") {
          const last = (localStorage.getItem("rehapp:lastPage") || "tagesprogramm").trim();
          location.hash = "#" + last;
        }
        routeToHash();
      }
    });
  </script>
</body>
</html>
