<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Reha Programm" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,..." />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>Reha Programm</title>
  <style>
    /* kleine Erg√§nzung f√ºr "Willkommen" */
    .sidebar-account .welcome-text { font-size:.9rem; color:#888; margin:2px 0 4px 4px; }
  </style>
</head>
<body class="center-auth">

  <!-- üîò Men√º-Button oben links -->
  <button id="menuToggle" class="menu-toggle" style="display:none;">‚ò∞</button>

  <!-- üåê Seitenmen√º -->
  <div id="sidebar">
    <div class="sidebar-header">
      <h2>Men√º</h2>
      <button id="closeSidebar">√ó</button>
    </div>
  
    <!-- üë§ Konto jetzt OBEN -->
    <div class="sidebar-account">
      <div class="welcome-text">Willkommen</div>
      <a class="account-row" href="#profil" title="Profil √∂ffnen">
        <svg class="avatar-icon" width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.9"/>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6" fill="currentColor" opacity="0.5"/>
        </svg>
        <span id="sidebar-name">‚Äî</span>
      </a>
    </div>
  
    <!-- Navi bleibt darunter -->
    <nav class="sidebar">
      <a href="#trainingsplan" data-match="trainingsplan">üèãÔ∏è Trainingsplan</a>
      <a href="#fortschritt"   data-match="fortschritt">üìä Fortschritt</a>
      <a href="#tagesprogramm" data-match="tagesprogramm">üóìÔ∏è Tagesprogramm</a>
      <a href="#kalender"      data-match="kalender">üìÖ Kalender</a>
      <a href="#NP"            data-match="feedback">üßæ Nachbehandlungsplan</a>
      <a href="#termine"       data-match="termine">üóÇÔ∏è Termine</a>
      <a href="#kontaktieren"  data-match="feedback">üìû Kontaktieren</a>
     <!-- <a href="#rezepte"       data-match="rezepte">üßæ Rezepte</a>
     <!-- <a href="#feedback"      data-match="feedback">‚≠ê Feedback</a> -->
      <a href="#profil"        data-match="profil">üë§ Profil</a>
     <!-- <a href="#hilfe"         data-match="hilfe">‚ùì Hilfe</a> -->
    </nav>
  
    <div class="sidebar-footer">
      <button id="sign-out" class="logout-btn">üö™ Abmelden</button>
    </div>
  </div>

  <!-- üîê Auth-Bereich -->
  <div class="card" id="auth-forms">
    <h2 id="auth-title">Anmeldung</h2>

    <!-- Login -->
    <form id="login-form" onsubmit="return false;">
      <input id="li-email"    type="email"    placeholder="E-Mail" required />
      <input id="li-password" type="password" placeholder="Passwort" required />
  
      <div class="login-actions" style="display:flex;justify-content:space-between;gap:.5rem;align-items:center;margin:.5rem 0 0;">
        <button type="submit">Anmelden</button>
        <button type="button" id="forgotBtn" class="linklike" style="background:none;border:none;color:#2563EB;cursor:pointer;padding:.25rem .25rem;">
          Passwort vergessen?
        </button>
      </div>
    </form>
  
    <!-- Link zum Signup -->
    <div style="margin-top:12px;">
      <a href="#signup" id="signupLink" style="color:#2563EB;text-decoration:underline;">Konto erstellen</a>
    </div>
  
    <!-- Signup -->
    <form id="signup-form" onsubmit="return false;" style="display:none; margin-top:16px;">
      <input id="su-firstname"  type="text"     placeholder="Vorname" required />
      <input id="su-lastname"   type="text"     placeholder="Nachname" required />
      <input id="su-birthdate"  type="date"     placeholder="Geburtsdatum" />
      <input id="su-email"      type="email"    placeholder="E-Mail" required />
      <input id="su-password"   type="password" placeholder="Passwort (min. 6 Zeichen)" minlength="6" required />
  
      <label for="su-group" style="margin-top:.5rem;display:block;">Gruppe</label>
      <select id="su-group" required style="width:100%;padding:.6rem;border-radius:.5rem;border:1px solid:#ccc;">
        <option value="" disabled selected>Bitte ausw√§hlen‚Ä¶</option>
        <option value="Knie">Knie</option>
        <option value="H√ºfte">H√ºfte</option>
        <option value="Arm">Arm</option>
        <option value="Onkologie">Onkologie</option>
      </select>
  
      <button type="submit" style="margin-top:12px;">Konto erstellen</button>
  
      <div style="margin-top:12px;">
        <a href="#login" id="backToLogin" style="color:#2563EB;text-decoration:underline;">Zur√ºck zur Anmeldung</a>
      </div>
    </form>
  </div>
  

  <!-- üîê Gesch√ºtzte App -->
  <div id="app" class="container" style="display:none;">
    <div id="user-area" style="display:none;">
      <span id="user-info">Nicht angemeldet</span>
    </div>

    <div id="app-section">
      <main id="content" class="main-content"></main>
    </div>

    <div class="sync-status" id="syncStatus">Synchronisiere‚Ä¶</div>
    <div class="edit-section" id="editSection">
      <div class="edit-area active" id="editArea">
        <textarea class="edit-textarea" id="scheduleEditor" placeholder="Programm hier bearbeiten‚Ä¶"></textarea>
        <button class="save-btn" id="saveBtn">Speichern</button>
        <div class="qr-section">
          <div class="qr-title">App teilen via QR-Code</div>
          <div class="qr-code" id="qrCode"></div>
          <div class="qr-url"  id="qrUrl"></div>
        </div>
      </div>
    </div>

    <!-- üìù Notizen Modal -->
    <div class="note-modal" id="noteModal">
      <div class="note-modal-content">
        <div class="note-modal-title" id="noteModalTitle">Notiz hinzuf√ºgen</div>
        <textarea class="note-textarea" id="noteTextarea" placeholder="Hier k√∂nnen Sie eine Notiz zu diesem Termin hinzuf√ºgen‚Ä¶"></textarea>
        <div class="note-modal-buttons">
          <button class="note-save-btn"   id="noteSaveBtn">Speichern</button>
          <button class="note-cancel-btn" id="noteCancelBtn">Abbrechen</button>
        </div>
        <button class="note-delete-btn" id="noteDeleteBtn" style="display:none;">Notiz l√∂schen</button>
      </div>
    </div>
  </div>

  <script src="schedule-data.js"></script>

  <script type="module">
    /* ======================
       1) IMPORTS (m√ºssen ganz oben stehen)
       ====================== */
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      sendPasswordResetEmail, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  
    /* ======================
       2) FIREBASE INIT
       ====================== */
    const firebaseConfig = {
      apiKey: "AIzaSyDJkR9vgTV4tzkVYGUQzA8o-bEU2Lq_now",
      authDomain: "reha-app-3d609.firebaseapp.com",
      projectId: "reha-app-3d609",
      storageBucket: "reha-app-3d609.firebasestorage.app",
      messagingSenderId: "805175943839",
      appId: "1:805175943839:web:60e9ffefba4eb4ccb7f8aa"
    };
    const appFB = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth  = getAuth(appFB);
    const db    = getFirestore(appFB);
    window.auth = auth;
    window.db   = db;
  
    /* ======================
       3) DOM ELEMENTE & HELPERS
       ====================== */
    const authForms   = document.getElementById("auth-forms");
    const appDiv      = document.getElementById("app");
    const userInfo    = document.getElementById("user-info");
    const signOutBtn  = document.getElementById("sign-out");
    const sidebar     = document.getElementById("sidebar");
    const menuToggle  = document.getElementById("menuToggle");
    const closeSidebar= document.getElementById("closeSidebar");
  
    const setMenuToggleVisible = (v) => { if (menuToggle) menuToggle.style.display = v ? "block" : "none"; };
  
    const showAuth = () => {
      document.body.classList.add("center-auth");
      if (authForms) authForms.style.display="block";
      if (appDiv)    appDiv.style.display="none";
    };
    const showApp = () => {
      document.body.classList.remove("center-auth");
      if (authForms) authForms.style.display="none";
      if (appDiv)    appDiv.style.display="block";
    };

    // Sidebar-Name aktualisieren: Firestore -> displayName -> Email
    async function updateSidebarAccount(user) {
      const nameEl = document.getElementById("sidebar-name");
      if (!nameEl) return;
      if (!user) { nameEl.textContent = "‚Äî"; return; }
      try {
        const ref  = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const { firstName = "", lastName = "" } = snap.data();
          const fullName = `${firstName} ${lastName}`.trim();
          if (fullName) { nameEl.textContent = fullName; return; }
        }
      } catch (e) { console.warn("Profil nicht lesbar:", e); }
      nameEl.textContent = user.displayName || user.email || "Unbekannt";
    }
  
    function loadAppJSOnce() {
      if (document.getElementById("app-js-loaded")) return;
      const s = document.createElement("script");
      s.src = "app.js";
      s.id = "app-js-loaded";
      s.type = "module";
      document.body.appendChild(s);
    }
  
    /* ======================
       4) SIDEBAR UI
       ====================== */
    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.add("active");
        setMenuToggleVisible(false);
      });
    }
    if (closeSidebar) {
      closeSidebar.addEventListener("click", () => {
        sidebar.classList.remove("active");
        setMenuToggleVisible(true);
      });
    }
    const navEl = document.querySelector("#sidebar nav.sidebar");
    if (navEl) {
      navEl.addEventListener("click", (e) => {
        const link = e.target.closest("a");
        if (!link) return;
        sidebar.classList.remove("active");
        setMenuToggleVisible(true);
      });
    }
  
    if (signOutBtn) {
      signOutBtn.addEventListener("click", async () => {
        sidebar.classList.remove("active");
        setMenuToggleVisible(true);
        try { await signOut(auth); } catch { alert("Abmelden fehlgeschlagen."); }
      });
    }
  
    /* ======================
       5) VIEW LOADER & ROUTER
       ====================== */
    async function loadView(page) {
      const mount   = document.getElementById("content");
      const viewPath = `views/${page}.html`;
      const cssPath  = `views/${page}.css`;
      const jsPath   = `views/${page}.js`;
  
      try {
        const res  = await fetch(viewPath);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();
  
        const parser = new DOMParser();
        const doc    = parser.parseFromString(html, "text/html");
        const newContent = doc.body.innerHTML;
  
        document.querySelectorAll('link[data-view]').forEach(l => l.remove());
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = cssPath;
        link.dataset.view = page;
        document.head.appendChild(link);
  
        if (mount) mount.innerHTML = newContent;
  
        document.getElementById("dynamic-view-script")?.remove();
        const script = document.createElement("script");
        script.src = jsPath;
        script.id  = "dynamic-view-script";
        script.defer = true;
        document.body.appendChild(script);
      } catch (e) {
        if (mount) mount.innerHTML = `<div style="padding:1rem;">‚ùå Konnte "${page}" nicht laden.<br>${e}</div>`;
      }
    }
  
    function routeToHash() {
      let page = (location.hash || "#tagesprogramm").slice(1).trim();
      if (!page) page = "tagesprogramm";

      // WICHTIG: Diese Hashes sind nur f√ºr die Auth-View ‚Äì keine View laden
      if (page === "signup" || page === "login") {
        updateAuthView();
        return;
      }
  
      loadView(page);
      sidebar.classList.remove("active");
      setMenuToggleVisible(true);
      document.querySelectorAll("#sidebar nav.sidebar a").forEach(a => {
        a.classList.toggle("active", a.getAttribute("href") === `#${page}`);
      });
      try { localStorage.setItem("rehapp:lastPage", page); } catch {}
    }
  
    window.addEventListener("hashchange", routeToHash);
  
    /* ======================
       6) AUTH: LOGIN / SIGNUP / RESET
       ====================== */
    const loginForm = document.getElementById("login-form");
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("li-email")?.value.trim();
        const pw    = document.getElementById("li-password")?.value;
        if (!email || !pw) return;
        try {
          await signInWithEmailAndPassword(auth, email, pw);
          location.hash = "#tagesprogramm";
          routeToHash();
        } catch (err) {
          alert(`Login fehlgeschlagen: ${err.code}`);
        }
        return false;
      });
    }
  
    const forgotBtn = document.getElementById("forgotBtn");
    if (forgotBtn) {
      forgotBtn.addEventListener("click", async () => {
        const email = (document.getElementById("li-email")?.value || "").trim()
                   || prompt("Bitte E-Mail f√ºr das Zur√ºcksetzen eingeben:") || "";
        if (!email) return;
        try {
          await sendPasswordResetEmail(auth, email);
          alert(`Passwort-Reset gesendet an: ${email}`);
        } catch (err) {
          alert(`Zur√ºcksetzen fehlgeschlagen: ${err.code}`);
        }
      });
    }

    // Signup: Auth-Account + Firestore-Profil
    const signupForm = document.getElementById("signup-form");
    if (signupForm) {
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const firstName = document.getElementById("su-firstname")?.value.trim();
        const lastName  = document.getElementById("su-lastname")?.value.trim();
        const birthdate = document.getElementById("su-birthdate")?.value || null;
        const group     = document.getElementById("su-group")?.value;
        const email     = document.getElementById("su-email")?.value.trim();
        const pw        = document.getElementById("su-password")?.value;

        if (!firstName || !lastName || !group || !email || !pw) {
          alert("Bitte alle Pflichtfelder ausf√ºllen.");
          return;
        }

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pw);
          const uid  = cred.user.uid;

          try { await updateProfile(cred.user, { displayName: `${firstName} ${lastName}` }); }
          catch (e) { console.warn("displayName nicht gesetzt:", e); }

          try {
            await setDoc(doc(db, "users", uid), {
              uid, email, firstName, lastName, birthdate, group,
              createdAt: serverTimestamp()
            });
          } catch (e) {
            console.error("Firestore setDoc fehlgeschlagen:", e);
            alert(`Profil speichern fehlgeschlagen: ${e.code || e.message || e}`);
            return;
          }

          alert("Konto erstellt. Du bist jetzt angemeldet.");
          location.hash = "#tagesprogramm";
          routeToHash();
        } catch (err) {
          console.error("Signup fehlgeschlagen:", err);
          const map = {
            "auth/operation-not-allowed": "E-Mail/Passwort ist im Projekt nicht aktiviert.",
            "auth/email-already-in-use": "Diese E-Mail wird bereits verwendet.",
            "auth/invalid-email": "Die E-Mail-Adresse ist ung√ºltig.",
            "auth/weak-password": "Passwort ist zu schwach (mind. 6 Zeichen).",
            "auth/network-request-failed": "Netzwerkfehler (z. B. von file:// gestartet?).",
            "auth/unauthorized-domain": "Domain nicht bei Firebase autorisiert."
          };
          alert(map[err.code] || `Registrierung fehlgeschlagen: ${err.code || err.message}`);
        }
      });
    }
  
    /* ======================
       7) AUTH STATE -> UI & ROUTING
       ====================== */
    function updateAuthView() {
      const loginForm  = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const titleEl    = document.getElementById("auth-title");

      if (!auth.currentUser) {
        const h = (location.hash || "").toLowerCase();
        const wantSignup = h.includes("#signup");
        if (titleEl)    titleEl.textContent = wantSignup ? "Konto erstellen" : "Anmeldung";
        if (loginForm)  loginForm.style.display  = wantSignup ? "none" : "block";
        if (signupForm) signupForm.style.display = wantSignup ? "block" : "none";
      }
    }

    let didInitialLoad = false;
    onAuthStateChanged(auth, (user) => {
      if (user) {
        showApp();
        setMenuToggleVisible(true);
        sidebar.classList.remove("active");

        window.currentUserId   = user.uid;
        window.currentUserName = user.displayName || user.email || ("UID: " + user.uid);

        const emailOrName = user.displayName || user.email || ("UID: " + user.uid);
        if (userInfo) userInfo.textContent = `Angemeldet: ${emailOrName}`;
        if (signOutBtn) signOutBtn.style.display = "inline-block";

        updateSidebarAccount(user);
        loadAppJSOnce();

        if (!didInitialLoad) {
          if (!location.hash || location.hash === "#" || location.hash === "#login" || location.hash === "#signup") {
            location.replace("#tagesprogramm");
            routeToHash();
          } else {
            routeToHash();
          }
          didInitialLoad = true;
        }
      } else {
        showAuth();
        setMenuToggleVisible(false);
        sidebar.classList.remove("active");
        if (userInfo) userInfo.textContent = "Nicht angemeldet";
        if (signOutBtn) signOutBtn.style.display = "none";
        window.currentUserId = null;
        window.currentUserName = null;
        updateSidebarAccount(null);
        didInitialLoad = false;
        updateAuthView();
      }
    });

    updateAuthView();
  </script>

  <!-- üìÑ pdf.js f√ºr den Reha-Kalender-Import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js";
    } else {
      console.error("pdf.js wurde nicht geladen");
    }
  </script>
</body>
</html>

<!-- =============================
     NEUE DATEIEN: Profil-Ansicht
     ============================= -->

<!-- Datei: views/profil.html -->
<!-- ... (dein Kommentarblock bleibt unver√§ndert) ... -->
